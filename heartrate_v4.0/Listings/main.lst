C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\APP-Keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2           * 这个程序是一个简单的心跳速率监测和警告系统，使用了LCD显示心率数值以及
             -低警告值。
   3           * 通过按键可以循环切换显示当前心率、低警告值和高警告值界面，并且可以对
             -告值进行设置。
   4           */
   5          #include <REGX52.H>
   6          #include <intrins.h>
   7          
   8          #define uint            unsigned int
   9          #define uchar           unsigned char
  10          #define ulong           unsigned long
  11          #define LCD_DATA        P0                              // 定义LCD的数据端口
  12          
  13          // 定义特殊功能寄存器位
  14          sbit LCD_RS =P2^5;      // LCD命令/数据选择位
  15          sbit LCD_RW =P2^6;      // LCD读/写选择位
  16          sbit LCD_E  =P2^7;      // LCD使能信号
  17          
  18          sbit Xintiao =P1^0;     // 心跳输入信号
  19          sbit speaker =P2^4;     // 蜂鸣器输出信号
  20          
  21          // 延时函数声明
  22          void delay5ms(void);
  23          // LCD操作函数声明
  24          void LCD_WriteData(uchar LCD_1602_DATA);
  25          void LCD_WriteCom(uchar LCD_1602_COM);
  26          void lcd_1602_word(uchar Adress_Com,uchar Num_Adat,uchar *Adress_Data);
  27          void InitLcd(); // LCD初始化
  28          // 定时器初始化函数声明
  29          void Tim_Init();
  30          
  31          // 全局变量声明
  32          uchar Xintiao_Change=0;         // 心跳计数状态标志
  33          uint  Xintiao_Jishu;            // 心跳周期计数值
  34          uchar stop;             // 心跳检测停止标志
  35          uchar View_Data[3];             // 显示数据缓冲区
  36          uchar View_L[3];                // 低警告值显示缓冲区
  37          uchar View_H[3];                // 高警告值显示缓冲区
  38          uchar Xintiao_H=100;            // 高警告阈值
  39          uchar Xintiao_L=40;             // 低警告阈值
  40          
  41          
  42          uchar Key_Change;               // 按键状态改变标志
  43          uchar Key_Value;                // 按键值
  44          uchar View_Con;         // 当前显示界面索引
  45          uchar View_Change;              // 显示更新标志
  46          
  47          // 主函数：初始化LCD和定时器，进入主循环监控按键输入与心跳速率，并根据状
             -更新显示
  48          void main()
  49          {
  50   1              InitLcd();
  51   1              Tim_Init();             // 初始化LCD和定时器
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 2   

  52   1              lcd_1602_word(0x80,16,"Heart Rate:     ");      // 在LCD上显示初始界面
  53   1              TR0=1;
  54   1              TR1=1;          // 开启定时器0和定时器1，进入主循环监控按键输入与心跳速率，并根据
             -态更新显示
  55   1              while(1)
  56   1              {
  57   2                      // 检测按键状态变化，并根据按键值更新显示界面或修改警告值
  58   2                      if(Key_Change)
  59   2                      {
  60   3                              Key_Change = 0;         //复位按键状态改变标志
  61   3                              View_Change = 1;        // 触发显示更新标志
  62   3                              switch(Key_Value)
  63   3                              {
  64   4                                      case 1:
  65   4                                      {
  66   5                                              View_Con++;
  67   5                                              if(View_Con == 3)       // 如果当前界面是高警告值设置界面，则循环回到低警告值设
             -界面
  68   5                                                      View_Con = 0;
  69   5                                              break;          //0-1-2循环
  70   5                                      }
  71   4                                      case 2:
  72   4                                      {
  73   5                                              if(View_Con == 2)       // 在高警告值设置界面时，增加高警告值
  74   5                                              {
  75   6                                                      if(Xintiao_H < 150)
  76   6                                                              Xintiao_H++;
  77   6                                              }
  78   5                                              if(View_Con == 1)       // 在低警告值设置界面时，增加低警告值
  79   5                                              {
  80   6                                                      if(Xintiao_L < Xintiao_H-1)
  81   6                                                              Xintiao_L++;
  82   6                                              }
  83   5                                              break;
  84   5                                      }
  85   4                                      case 3:
  86   4                                      {
  87   5                                              if(View_Con == 2)       // 在高警告值设置界面时，减少高警告值
  88   5                                              {
  89   6                                                      if(Xintiao_H > Xintiao_L+1)
  90   6                                                              Xintiao_H--;
  91   6                                              }
  92   5                                              if(View_Con == 1)        // 在低警告值设置界面时，减少低警告值
  93   5                                              {
  94   6                                                      if(Xintiao_L > 30)
  95   6                                                              Xintiao_L--;
  96   6                                              }
  97   5                                              break;
  98   5                                      } 
  99   4                              }
 100   3                      }
 101   2                      // 根据显示更新标志更新LCD显示内容
 102   2                      if(View_Change)
 103   2                      {
 104   3                              View_Change = 0;        // 复位显示更新标志
 105   3                              if(stop == 0)   // 如果心跳检测未停止，更新显示数据
 106   3                              {
 107   4                                      if(View_Data[0] == 0x30)
 108   4                                              View_Data[0] = ' ';     // 将空数据字符替换为空格
 109   4                              }
 110   3                              else    // 如果心跳检测已停止，清空显示数据
 111   3                              {
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 3   

 112   4                                      View_Data[0] = ' ';
 113   4                                      View_Data[1] = ' ';
 114   4                                      View_Data[2] = ' ';
 115   4                              }
 116   3      
 117   3                              switch(View_Con)        // 根据当前显示界面，更新相应的显示内容
 118   3                              {
 119   4                                      case 0: // 当前显示心率界面
 120   4                                      {
 121   5                                              lcd_1602_word(0x80,16,"Heart Rate:     ");
 122   5                                              lcd_1602_word(0xc0,16,"                ");
 123   5                                              lcd_1602_word(0xcd,3,View_Data);
 124   5                                              break;
 125   5                                      }
 126   4                                      case 1:  // 当前显示低警告值设置界面
 127   4                                      {
 128   5                                              lcd_1602_word(0x80,16,"Heart Rate:     ");
 129   5                                              lcd_1602_word(0x8d,3,View_Data);
 130   5                                 
 131   5                                              View_L[0] = Xintiao_L / 100 + 0x30;     // 将低警告值转换为字符形式
 132   5                                              View_L[1] = Xintiao_L % 100 / 10 + 0x30;
 133   5                                              View_L[2] = Xintiao_L % 10 + 0x30;
 134   5      
 135   5                                              if(View_L[0] == 0x30)
 136   5                                                      View_L[0] = ' ';        // 处理低警告值显示字符前的空字符
 137   5                                 
 138   5                                              lcd_1602_word(0xC0,16,"Warning L :     ");
 139   5                                              lcd_1602_word(0xCd,3,View_L);
 140   5                                              break;
 141   5                                      }
 142   4                                      case 2: // 当前显示高警告值设置界面
 143   4                                      {
 144   5                                              lcd_1602_word(0x80,16,"Heart Rate:     ");
 145   5                                              lcd_1602_word(0x8d,3,View_Data);
 146   5                                 
 147   5                                              View_H[0] = Xintiao_H / 100 + 0x30;     // 将高警告值转换为字符形式
 148   5                                              View_H[1] = Xintiao_H % 100 / 10 + 0x30;
 149   5                                              View_H[2] = Xintiao_H % 10 + 0x30;
 150   5      
 151   5                                              if(View_H[0] == 0x30)
 152   5                                                      View_H[0] = ' ';        // 处理高警告值显示字符前的空字符
 153   5                                 
 154   5                                              lcd_1602_word(0xC0,16,"Warning H :     ");
 155   5                                              lcd_1602_word(0xCd,3,View_H);
 156   5                                              break;
 157   5                                      }
 158   4                              }
 159   3                      }
 160   2              }
 161   1      }
 162          
 163          /* 定时器1中断服务函数：处理按键输入和心跳检测 */
 164          void Time1() interrupt 3
 165          {
 166   1              static uchar Key_Con,Xintiao_Con;
 167   1              TH1=0xd8;
 168   1              TL1=0xf0;
 169   1              switch(Key_Con)
 170   1              {
 171   2                      case 0: // 按键按下检测
 172   2                      {
 173   3                              if((P3 & 0x07) != 0x07)
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 4   

 174   3                              {
 175   4                                      Key_Con++;
 176   4                              }
 177   3                              break;
 178   3                      }
 179   2                      case 1: // 确认按键按下
 180   2                      {
 181   3                              if((P3 & 0x07) != 0x07)
 182   3                              {
 183   4                                      Key_Con++;
 184   4                                      switch(P3 & 0x07)       // 确定是哪个按键按下
 185   4                                      {
 186   5                                              case 0x06: Key_Value = 1; break;
 187   5                                              case 0x05: Key_Value = 2; break;
 188   5                                              case 0x03: Key_Value = 3; break;
 189   5                                      }
 190   4                              }
 191   3                              else
 192   3                              {
 193   4                                      Key_Con = 0;
 194   4                              }
 195   3                              break;
 196   3                      }
 197   2                      case 2: // 等待按键释放
 198   2                      {
 199   3                              if((P3&0x07) == 0x07)
 200   3                              {
 201   4                                      Key_Change = 1; // 触发按键状态改变标志
 202   4                                      Key_Con = 0;
 203   4                              }
 204   3                              break;
 205   3                      }
 206   2              }
 207   1              
 208   1              switch (Xintiao_Con)    // 处理心跳信号输入
 209   1              {
 210   2                      case 0: // 等待心跳信号
 211   2                      {
 212   3                              if(!Xintiao)
 213   3                              {
 214   4                                      Xintiao_Con++;
 215   4                              }
 216   3                              break;
 217   3                      }
 218   2                      case 1: // 确认心跳信号未收到
 219   2                      {
 220   3                              if(!Xintiao)
 221   3                              {
 222   4                                      Xintiao_Con++;
 223   4                              }
 224   3                              else
 225   3                              {
 226   4                                      Xintiao_Con = 0;
 227   4                              }
 228   3                              break;
 229   3                      }
 230   2                      case 2: // 等待下一个心跳周期
 231   2                      {
 232   3                              if(!Xintiao)
 233   3                              {
 234   4                                      Xintiao_Con++;
 235   4                              }
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 5   

 236   3                              else
 237   3                              {
 238   4                                      Xintiao_Con = 0;
 239   4                              } 
 240   3                              break;
 241   3                      }
 242   2                      case 3: // 等待确认心跳周期
 243   2                      {
 244   3                              if(!Xintiao)
 245   3                              {
 246   4                                      Xintiao_Con++;
 247   4                              }
 248   3                              else
 249   3                              {
 250   4                                      Xintiao_Con = 0;
 251   4                              } 
 252   3                              break;
 253   3                      }
 254   2                      case 4:  // 处理心跳周期计数和更新显示
 255   2                      {
 256   3                              if(Xintiao)
 257   3                              {
 258   4                                      if(Xintiao_Change == 1) // 如果是新的心跳周期
 259   4                                      {
 260   5                                              View_Data[0] = (60000 / Xintiao_Jishu) / 100 + 0x30;    // 计算并转换为字符形式
 261   5                                              View_Data[1] = (60000 / Xintiao_Jishu) % 100 / 10 + 0x30;
 262   5                                              View_Data[2] = (60000 / Xintiao_Jishu) % 10 + 0x30;
 263   5                                                                                                        
 264   5                                              if(((60000/Xintiao_Jishu)>=Xintiao_H)||((60000/Xintiao_Jishu)<=Xintiao_L))
 265   5                                                      speaker = 0;    // 关闭蜂鸣器
 266   5                                              else
 267   5                                                      speaker = 1;
 268   5                                              
 269   5                                              View_Change = 1;
 270   5                                              Xintiao_Jishu = 0;
 271   5                                              Xintiao_Change = 0;
 272   5                                              stop = 0;                       }
 273   4                                      else
 274   4                                      {
 275   5                                              Xintiao_Jishu = 0;
 276   5                                              Xintiao_Change = 1;
 277   5                                      }
 278   4                                      Xintiao_Con = 0;
 279   4                                      break;
 280   4                              }
 281   3                      }
 282   2              }
 283   1      }
 284          
 285          void Time0() interrupt 1
 286           /* * 函数名称：Time0
 287            * 描述：定时器0中断服务函数，用于实现特定时间间隔的任务。
 288            */
 289          {
 290   1              TH0=0xfc;
 291   1              TL0=0x18;
 292   1              Xintiao_Jishu++;
 293   1              if(Xintiao_Jishu == 5000)
 294   1              {
 295   2                      Xintiao_Jishu = 0;
 296   2                      View_Change = 1;
 297   2                      Xintiao_Change = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 6   

 298   2                      stop = 1;
 299   2                      speaker = 1;
 300   2              }
 301   1      }
 302          
 303          void Tim_Init()
 304          /* * 函数名称：Tim_Init
 305           * 功能描述：初始化定时器0和定时器1，设置为模式1，启动定时器。
 306           */
 307          {
 308   1              EA = 1;
 309   1              ET0 = 1;
 310   1              ET1 = 1;
 311   1              TMOD = 0x11;
 312   1              TH0 = 0xfc;
 313   1              TL0 = 0x18;
 314   1       
 315   1              TH1 = 0xd8;
 316   1              TL1 = 0xf0;
 317   1      }
 318          
 319          void lcd_1602_word(uchar Adress_Com, uchar Num_Adat, uchar *Adress_Data)
 320          /* * @brief 向LCD 1602显示器发送一个字节的数据流.
 321           * 该函数通过指定的命令地址和数据地址，将一个字节的数据流发送到LCD 1602显
             -器.
 322           * * @param Adress_Com 命令地址。用于指定LCD要执行的操作。
 323           * * @param Num_Adat 要发送的数据字节数。
 324           * * @param Adress_Data 数据指针。指向要发送的数据的起始位置。
 325           */
 326          {
 327   1              uchar a = 0;
 328   1              uchar Data_Word;
 329   1              LCD_WriteCom(Adress_Com);
 330   1              for(a = 0; a < Num_Adat; a++)
 331   1              {
 332   2                      Data_Word = *Adress_Data;
 333   2                      LCD_WriteData(Data_Word);
 334   2                      Adress_Data++;
 335   2              }
 336   1      }
 337          
 338          void LCD_WriteData(uchar LCD_1602_DATA)
 339          /* * @brief 向LCD写入数据
 340           * 该函数用于向1602型号的LCD写入一个字节的数据。在写入数据前，会先进行一个
             -5ms的延时，然后设置LCD的相关控制信号线，
 341           * 包括使能信号(E)，寄存器选择信号(RS)，读写信号(RW)，最后写入数据并恢复控
             -信号线的状态。
 342           * * @param LCD_1602_DATA 要写入LCD的数据，类型为uchar（无符号字符）
 343           */
 344          {
 345   1              delay5ms();
 346   1              LCD_E = 0;
 347   1              LCD_RS = 1;
 348   1              LCD_RW = 0;
 349   1              _nop_();
 350   1              LCD_E = 1;
 351   1              LCD_DATA = LCD_1602_DATA;
 352   1              LCD_E = 0;
 353   1              LCD_RS = 0;
 354   1      }
 355          
 356          
C51 COMPILER V9.60.7.0   MAIN                                                              05/14/2024 00:44:31 PAGE 7   

 357          void LCD_WriteCom(uchar LCD_1602_COM)
 358          /* * @brief 向LCD写入命令
 359           * 该函数用于向1602型号的LCD写入指定的命令。
 360           * 写入命令的过程包括：设置LCD使能信号、设置LCD命令/数据选择信号、
 361           * 设置LCD读写信号、写入数据并恢复初始状态。
 362           * * @param LCD_1602_COM 要写入LCD的命令字节
 363           */
 364          {
 365   1              delay5ms();
 366   1              LCD_E = 0;
 367   1              LCD_RS = 0;
 368   1              LCD_RW = 0;
 369   1              _nop_();
 370   1              LCD_E = 1;
 371   1              LCD_DATA = LCD_1602_COM;
 372   1              LCD_E = 0;
 373   1              LCD_RS = 0;
 374   1      }
 375          
 376          
 377          void InitLcd()
 378          /* * 初始化LCD显示器
 379           * 该函数初始化LCD显示器，设置其显示模式并进行必要的初始化序列。
 380           */
 381          {
 382   1              delay5ms();
 383   1              delay5ms();
 384   1              LCD_WriteCom(0x38); 
 385   1              LCD_WriteCom(0x38); 
 386   1              LCD_WriteCom(0x38); 
 387   1              LCD_WriteCom(0x06);
 388   1              LCD_WriteCom(0x0c);
 389   1              LCD_WriteCom(0x01);
 390   1              delay5ms();
 391   1              delay5ms();
 392   1      }
 393          
 394          void delay5ms(void)     //@12.000MHz
 395          {
 396   1              unsigned char data i, j;
 397   1      
 398   1              i = 10;
 399   1              j = 183;
 400   1              do
 401   1              {
 402   2                      while (--j);
 403   2              } while (--i);
 404   1      }
 405          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1055    ----
   CONSTANT SIZE    =     68    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
